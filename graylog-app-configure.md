# Populate configuration of graylog app

<!-- TOC -->

- [Populate configuration of graylog app](#populate-configuration-of-graylog-app)
    - [Setup and run shell scripts method](#setup-and-run-shell-scripts-method)
        - [To run shell scripts method requires installing jq, curl,](#to-run-shell-scripts-method-requires-installing-jq-curl)
        - [Create scripts based on examples provided in source pack and execute](#create-scripts-based-on-examples-provided-in-source-pack-and-execute)
            - [a. Get admin token from Web UI Show Profile -> Edit Tokens and create shell variable](#a-get-admin-token-from-web-ui-show-profile---edit-tokens-and-create-shell-variable)
            - [b. Set up env vars for script runs and execute scripts assuming you tailored to your environment](#b-set-up-env-vars-for-script-runs-and-execute-scripts-assuming-you-tailored-to-your-environment)
    - [Setup python virtualenv and execute python scripts method](#setup-python-virtualenv-and-execute-python-scripts-method)
        - [To run creation/cleanup python scripts method requires installing jq and python virtualenv](#to-run-creationcleanup-python-scripts-method-requires-installing-jq-and-python-virtualenv)
        - [Run the python scripts in virtual env and other tools](#run-the-python-scripts-in-virtual-env-and-other-tools)
    - [How to send syslog messages to test input](#how-to-send-syslog-messages-to-test-input)

<!-- /TOC -->

**The graylog rest api browser (swagger) is very helpful for writing/testing/validating the curl and python methods**<br>
**There's a link to it from the UI or go to the following url that corresponds to your host**<br>
**ex: http://192.168.1.2:9000/api/api-browser/global/index.html**

The progression followed was:
- Web UI config, get going, test features
- Use api browser to export configs or test config payloads or api endpoint behavior
- Shell script small set of hosts to understand dependencies and behavior
- Create python scripts to be able to just do config files and scale hosts

## Setup and run shell scripts method
### 1. To run shell scripts method requires installing jq, curl, 
```
sudo apt install -y jq curl pytest
or
sudo yum install -y jq curl pytest
```
### 2. Create scripts based on examples provided in source pack and execute
#### 2a. Get admin token from Web UI (Show Profile -> Edit Tokens) and create shell variable
```
# leave the space so token doesn't go into shell history
 export admintoken=<token goes here>
```
#### 2b. Set up env vars for script runs and execute scripts (assuming you tailored to your environment)
**You will need to modify for your host/ip**
```
export url=http://192.168.1.2:9000/api/
export postheaders=(-H "Accept: application/json" -H "Content-Type: application/json" -H "X-Requested-By: XMLHttpRequest")
export getheaders=(-H "Accept: application/json")
./hostsetup-host1.sh $admintoken $url
./hostsetup-host2.sh $admintoken $url
unset admintoken
```
## Setup python virtualenv and execute python scripts method
<span style="color:red;">
1. CAUTION !!!<br>
Read this entire section expecially before running "clean" script.
</span>

The graylog-clean.py script has no dependecy on config files and all previously recieved log data will be deleted.
Built in items that aren't affected:
- Default index set
- Graylog Events index set
- Graylog System Events index set
- All events stream
- All system events stream
- Default stream

The script uses the API to delete any user created config in the following order:
- streams
- inputs (and any associated extractors)
- index sets

The clean script is only intended to be used while developing config files, or when catastrophic situations occur. 
Understand that any collected log data will be lost, once indexes are deleted, unless it was routed into "Default stream", or is generated by the application itself. This is why there is no shell script for "clean" only host setup examples.

### 2. To run creation/cleanup python scripts method requires installing jq and python virtualenv
```
sudo apt install -y jq python3-virtualenv
or
sudo yum install -y jq python3-virtualenv
```
### 3. Run the python scripts in virtual env and other tools
1. Setup the python virtualenv in parent folder above graylogpyenv folder
```
virtualenv graylogpyenv
source graylogpyenv/bin/activate
pip3 install --upgrade pip setuptools wheel
pip3 install requests
pip3 install jqpy
pip3 install validators
pip3 install jsonschema
pip3 install pytest
pip3 install pytest-cov
pip3 install requests_mock
pip3 install pytest_mock
pip3 install pyclean
pip3 install pylint
pip3 freeze > requirements.txt
```
Or if you pulled this project from source
```
pip install -r requirements.txt
```
2. Run the python script to setup, clean, or verify the graylog app config. <br>
**(Leave a space to ensure token isn't stored in shell history)** <br>
examples assumes your graylog docker host is running/listening at 192.168.1.5 
```
python graylog_verify.py <verbose flag optional>

 python graylog-setup.py "token" "http://192.168.1.5:9000/api" <verbose flag optional>

# ONLY IF YOU READ AND UNDERSTAND EXPLANATION POSTED ABOVE IN CAUTION SECTION
 python graylog-clean.py "token" "http://192.168.1.5:9000/api" <verbose flag optional>
```
3. When done running python scripts to return to normal shell
```
deactivate
```
4. To re-run scripts inside a reactivated virtualenv
```
source graylogpyenv/bin/activate
python graylog-setup.py "token" "http://192.168.1.5:9000/api"
```
5. Run python tests inside virtualenv and get coverage report including missing coverage
```
python -m pytest tests -v --cov=. --cov-report term-missing
```
6. Clean up pycache and pytest_cache inside virtualenv
```
pyclean .
```
7. pylint
```
pylint --recursive=y --generate-rcfile > .pylintrc
add init-hook='import sys; sys.path.append(".")' to .pylintrc
pylint . --verbose --reports=y
dot -Tpng dependencies.gv -o imports_all.png (for dependency graph, assumes graphviz installed)

```
8. docstrings
```
To generate an output of all the docstrings:
python3 docstrings.py
```
## How to send syslog messages to test input
1. Example with graylog app running on host 192.168.1.2 and you want to send a message from another host or docker host itself
```
sudo echo "Test UDP syslog message"$(date) >> /dev/udp/192.168.1.2/5140
```
2. Example to test host you want to send data from an rsyslog config (usually /etc/rsyslog.d/host.conf) that is set to point to 192.168.1.2
```
logger "test udp syslog "$(date)
```